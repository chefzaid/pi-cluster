# Dashboard - unified dashboard for all cluster services
# Shows live health status, Prometheus widgets, and quick links
# Stateless config via ConfigMaps - no PVC needed
# Web UI available at http://dashboard.local
---
apiVersion: v1
kind: Namespace
metadata:
  name: dashboard
---
# ============================================================
#  Service Account - Dashboard needs read access to discover
#  services and ingresses across namespaces
# ============================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dashboard
  namespace: dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dashboard
rules:
  - apiGroups: [""]
    resources: [namespaces, pods, nodes]
    verbs: [get, list]
  - apiGroups: ["extensions", "networking.k8s.io"]
    resources: [ingresses]
    verbs: [get, list]
  - apiGroups: ["metrics.k8s.io"]
    resources: [pods, nodes]
    verbs: [get, list]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dashboard
subjects:
  - kind: ServiceAccount
    name: dashboard
    namespace: dashboard
---
# ============================================================
#  Configuration - services, widgets, bookmarks, settings
# ============================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: dashboard-config
  namespace: dashboard
data:
  settings.yaml: |
    title: Pi Cluster
    favicon: https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/raspberry-pi.svg
    headerStyle: clean
    layout:
      Infrastructure:
        style: row
        columns: 3
      Applications:
        style: row
        columns: 3
      Monitoring:
        style: row
        columns: 2

  widgets.yaml: |
    - kubernetes:
        cluster:
          show: true
          cpu: true
          memory: true
          showLabel: true
          label: "Pi Cluster"
        nodes:
          show: true
          cpu: true
          memory: true
          showLabel: true

  services.yaml: |
    - Infrastructure:
        - Longhorn:
            icon: longhorn
            href: http://longhorn.local
            description: Distributed storage
            namespace: longhorn-system
            app: longhorn-ui
        - AdGuard Home:
            icon: adguard-home
            href: http://adguard.local
            description: DNS ad blocker
            namespace: adguard
            app: adguard-home
        - Cloudflare Tunnel:
            icon: cloudflare
            description: Internet exposure
            namespace: cloudflared
            app: cloudflared
    - Applications:
        - Guacamole:
            icon: guacamole
            href: https://remote.swirlit.dev
            description: Remote desktop gateway
            namespace: guacamole
            app: guacamole
        - Open WebUI:
            icon: open-webui
            href: https://ai.swirlit.dev
            description: AI chat (v0.7.2)
            namespace: ai
            app: open-webui
        - AIOStreams:
            icon: stremio
            href: https://aiostreams.swirlit.dev
            description: Stremio addon aggregator
            namespace: aiostreams
            app: aiostreams
        - OpenClaw:
            icon: mdi-robot
            href: https://assistant.swirlit.dev
            description: AI assistant gateway
            namespace: openclaw
            app: openclaw
    - Monitoring:
        - Grafana:
            icon: grafana
            href: https://grafana.swirlit.dev
            description: Cluster dashboards
            namespace: monitoring
            app: grafana
        - Dashboard:
            icon: homepage
            href: https://dashboard.swirlit.dev
            description: This dashboard
            namespace: dashboard
            app: dashboard

  bookmarks.yaml: |
    - Management:
        - Cloudflare Dashboard:
            - icon: cloudflare
              href: https://one.dash.cloudflare.com/
        - GitHub Repo:
            - icon: github
              href: https://github.com/chefzaid/pi-cluster
        - Google AI Studio:
            - icon: google
              href: https://aistudio.google.com/apikey

  docker.yaml: ""
  custom.css: ""
  custom.js: ""
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard
  namespace: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard
  template:
    metadata:
      labels:
        app: dashboard
    spec:
      serviceAccountName: dashboard
      initContainers:
        - name: init-config
          image: busybox:latest
          command: ["sh", "-c", "cp /configmap/* /app-config/ && mkdir -p /app-config/logs"]
          volumeMounts:
            - name: configmap
              mountPath: /configmap
            - name: config
              mountPath: /app-config
      containers:
        - name: dashboard
          image: ghcr.io/gethomepage/homepage:latest
          ports:
            - containerPort: 3000
          env:
            - name: HOMEPAGE_ALLOWED_HOSTS
              value: "*"    # Allow all hosts (internal service behind ingress)
          volumeMounts:
            - name: config
              mountPath: /app/config
          resources:
            requests:
              memory: "96Mi"
              cpu: "15m"
            limits:
              memory: "256Mi"
              cpu: "150m"
          readinessProbe:
            httpGet:
              path: /api/healthcheck
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 10
            failureThreshold: 5
      volumes:
        - name: configmap
          configMap:
            name: dashboard-config
        - name: config
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: dashboard-service
  namespace: dashboard
spec:
  selector:
    app: dashboard
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dashboard-ingress
  namespace: dashboard
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
spec:
  rules:
    - host: dashboard.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dashboard-service
                port:
                  number: 80
